# 강사 배정 관리 시스템 — 기능명세서

> 최종 갱신: 2026-02-24

## 1. 시스템 개요

### 1-1. 목적

Notion 교육 대시보드 데이터를 기반으로 강사의 가용성과 배정을 관리하는 웹 시스템. 운영팀이 교육 일정에 강사를 배정하고, 강사가 자기 일정을 확인·관리할 수 있다.

### 1-2. 아키텍처

```
┌──────────────┐     ┌──────────────────┐     ┌─────────────┐
│  React SPA   │────▶│  FastAPI Backend  │────▶│  Supabase   │
│  (Vite)      │     │                  │     │  (DB/Auth)  │
└──────────────┘     └──────┬───────────┘     └─────────────┘
                            │
                     ┌──────▼───────────┐
                     │  Notion API      │
                     │  (동기화 소스)   │
                     └──────────────────┘
```

| 계층 | 기술 | 역할 |
|------|------|------|
| 프론트엔드 | React 19 + TypeScript + Vite + TailwindCSS | SPA UI |
| 백엔드 | Python 3.13 + FastAPI | REST API |
| 인증 | Supabase Auth (Google OAuth) | JWT 기반 인증 |
| DB | Supabase (PostgreSQL) | 데이터 저장 |
| 외부 연동 | Notion API (httpx) | 교육/강사 데이터 동기화 |

### 1-3. 배포 구조

| 구성요소 | 배포 대상 |
|---------|----------|
| 프론트엔드 | 정적 배포 (Vite build) |
| 백엔드 | API 서버 (uvicorn) |
| DB/Auth | Supabase 호스팅 |

### 1-4. 개발 서버

`dev_main.py`를 통해 FakeRepository(인메모리) 기반 개발 서버를 제공한다.

| 항목 | main.py (프로덕션) | dev_main.py (개발) |
|------|-------------------|-------------------|
| Repository | Supabase 연동 | FakeRepository (인메모리) |
| Notion 동기화 | 수동 (API 호출) | 서버 기동 시 자동 |
| 인증 | Supabase JWT | JWT + 이메일 도메인 라우팅 |
| CORS | 환경변수 제한 | 전체 허용 (`*`) |
| 데이터 지속성 | DB | 서버 종료 시 소멸 |

---

## 2. 인증 및 권한

### 2-1. 인증 흐름

```
사용자 → Google OAuth (Supabase) → JWT Access Token
→ /api/auth/me (Bearer) → UserProfile 반환 → 역할 기반 라우팅
```

1. 사용자가 Google OAuth로 로그인
2. Supabase가 JWT 토큰 발급
3. 프론트엔드가 `Authorization: Bearer <token>` 헤더로 `/api/auth/me` 호출
4. 백엔드가 JWKS 검증 후 프로필 반환
5. 역할에 따라 admin → `/dashboard`, instructor → `/instructor/schedule`로 리다이렉트

### 2-2. 역할

| 역할 | 설명 |
|------|------|
| `admin` | 운영팀. 전체 강사/교육/배정 관리 |
| `instructor` | 강사. 자기 일정 확인 + 가용성 등록 |

### 2-3. 접근 범위 매트릭스

| 기능 | admin | instructor |
|------|-------|-----------|
| 대시보드 | O | X |
| 강사 관리 | O | X |
| 교육 관리 | O | X |
| 캘린더 | O | X |
| 가용성 매트릭스 | O | X |
| 내 일정 | X | O |
| 내 교육 | X | O |
| Notion 동기화 | O | X |
| 가용성 등록 (자기) | X | O |
| 배정 생성/삭제 | O | X |

---

## 3. 데이터 모델

### 3-1. 엔티티 관계도

```
Instructor ──1:N── Assignment
     │                  │
     │               N:1│
     │            CourseDate ──N:1── Course
     │
     └──1:N── Availability
```

### 3-2. Instructor (강사)

| 필드 | 타입 | 설명 | 필수 |
|------|------|------|------|
| id | string (UUID) | PK | O |
| name | string | 강사 이름 | O |
| email | string \| null | 연락용 이메일 | |
| auth_email | string \| null | 로그인 이메일 (Google) | |
| phone | string \| null | 전화번호 | |
| specialty | string \| null | 역할 (예: "Technical Tutor") | |
| is_active | boolean | 활성 여부 | O |

### 3-3. Course (교육)

| 필드 | 타입 | 설명 | 필수 |
|------|------|------|------|
| id | string (UUID) | PK | O |
| notion_page_id | string | Notion 페이지 ID | O |
| title | string | 교육명 | O |
| status | string \| null | 교육 상태 (Notion lecture_state) | |
| target | string \| null | 교육 대상 | |
| students | int \| null | 수강생 수 | |
| lecture_start | string \| null | 교육 시작일 | |
| lecture_end | string \| null | 교육 종료일 | |
| workbook_full_url | string \| null | 교안 URL | |
| assignment_status | string \| null | "배정 완료" / "배정 미완료" | |
| total_dates | int \| null | 전체 교육일 수 | |
| assigned_dates | int \| null | 배정된 교육일 수 | |
| manager | string \| null | 담당 매니저 이름 | |
| manager_email | string \| null | 매니저 이메일 | |
| sales_rep | string \| null | 영업 담당 이름 | |
| sales_rep_email | string \| null | 영업 담당 이메일 | |

### 3-4. CourseDate (교육일)

| 필드 | 타입 | 설명 | 필수 |
|------|------|------|------|
| id | string (UUID) | PK | O |
| course_id | string | FK → Course | O |
| date | date | 교육 날짜 | O |
| day_number | int | 차시 번호 | O |
| place | string \| null | 장소 | |
| start_time | float \| null | 시작 시간 (소수점 시) | |
| end_time | float \| null | 종료 시간 (소수점 시) | |

### 3-5. Assignment (배정)

| 필드 | 타입 | 설명 | 필수 |
|------|------|------|------|
| id | string (UUID) | PK | O |
| course_date_id | string | FK → CourseDate | O |
| instructor_id | string | FK → Instructor | O |
| date | date | 배정 날짜 | O |
| class_name | string \| null | 반 이름 (A반, 기술지원 등) | |
| created_by | string \| null | 배정 생성자 ID | |

**업무 규칙:** 강사 1명 = 하루 1개 교육만 가능 (중복 배정 차단)

### 3-6. Availability (가용성)

| 필드 | 타입 | 설명 | 필수 |
|------|------|------|------|
| id | string (UUID) | PK | O |
| instructor_id | string | FK → Instructor | O |
| date | date | 가용성 날짜 | O |
| status | "available" \| "unavailable" | 상태 | O |
| reason | string \| null | 사유 | |

---

## 4. Notion 동기화

### 4-1. 개요

| 항목 | 내용 |
|------|------|
| 방향 | Notion → 로컬 DB (단방향) |
| 트리거 | 관리자 수동 (동기화 버튼) |
| 충돌 해소 | Notion 데이터가 항상 우선 (upsert) |
| 필터 | `lecture_state`가 "tax_invoice", "lecture_stop"인 교육은 제외 |

### 4-2. 동기화 대상

| Notion DB | 환경변수 | 동기화 대상 |
|-----------|---------|-----------|
| 강사 DB | `NOTION_DB_TUTOR` | Instructor |
| 교육 DB | `NOTION_DB_LECTURE` | Course |
| 일정 DB | `NOTION_DB_SCHEDULE` | CourseDate + Assignment |

### 4-3. 강사 동기화 필드 매핑

| Notion 필드 | 타입 | → 로컬 필드 |
|-------------|------|-----------|
| real_name | rich_text | name |
| unique_name (fallback) | title | name |
| email | email | email |
| phone_number | phone | phone |
| tutor_level | select | specialty |
| — | — | is_active = true (고정) |

### 4-4. 교육 동기화 필드 매핑

| Notion 필드 | 타입 | → 로컬 필드 |
|-------------|------|-----------|
| lecture_dashboard | title | title |
| lecture_state | status | status |
| lecture_start | rollup date | lecture_start |
| lecture_end | rollup date | lecture_end |
| students | number | students |
| target_name | rollup texts | target (콤마 조인) |
| workbook_full_URL | rollup URL | workbook_full_url |
| lecture_PIC | people | manager + manager_email |
| sales_PIC | people | sales_rep + sales_rep_email |

### 4-5. 일정 동기화 필드 매핑

| Notion 필드 | 타입 | → 로컬 필드 |
|-------------|------|-----------|
| date | date start | CourseDate.date |
| place | rich_text | CourseDate.place |
| start_time | number | CourseDate.start_time |
| end_time | number | CourseDate.end_time |
| lecture_dashboard | relation | → course_id (역참조) |
| main_tutor | relation | → Assignment (class_name="A반") |
| tech_tutor | relation | → Assignment (class_name="기술지원") |

### 4-6. 배정 상태 계산

동기화 후 각 Course에 대해:
- `total_dates`: 전체 CourseDate 수
- `assigned_dates`: 배정이 1건 이상인 CourseDate 수
- `assignment_status`: "배정 완료" (assigned ≥ total) / "배정 미완료" (assigned < total)

---

## 5. API 엔드포인트 명세

### 5-1. 인증 (`/api/auth`)

| Method | Path | 설명 | 인증 |
|--------|------|------|------|
| GET | `/api/auth/me` | 현재 사용자 프로필 조회 | Bearer JWT |

**응답:** `{ user_id, email, role, display_name, instructor_id }`

### 5-2. 강사 (`/api/instructors`)

| Method | Path | 설명 | 인증 |
|--------|------|------|------|
| POST | `/api/instructors/sync` | Notion에서 강사 동기화 | admin |
| GET | `/api/instructors/available` | 특정 날짜 가용 강사 | 로그인 |
| GET | `/api/instructors` | 강사 목록 | 로그인 |
| GET | `/api/instructors/{id}` | 강사 상세 | 로그인 |
| GET | `/api/instructors/{id}/courses` | 강사의 교육 목록 (페이지네이션) | 로그인 |
| POST | `/api/instructors` | 강사 생성 | admin |
| PUT | `/api/instructors/{id}` | 강사 수정 | admin |
| DELETE | `/api/instructors/{id}` | 강사 삭제 | admin |

### 5-3. 교육 (`/api/courses`)

| Method | Path | 설명 | 인증 |
|--------|------|------|------|
| POST | `/api/courses/sync` | Notion에서 교육+일정+배정 동기화 | admin |
| GET | `/api/courses` | 교육 목록 | 로그인 |
| GET | `/api/courses/{id}` | 교육 상세 (일자 포함) | 로그인 |
| POST | `/api/courses` | 교육 생성 | admin |
| PUT | `/api/courses/{id}` | 교육 수정 | admin |
| DELETE | `/api/courses/{id}` | 교육 삭제 | admin |

### 5-4. 배정 (`/api/assignments`)

| Method | Path | 설명 | 인증 |
|--------|------|------|------|
| GET | `/api/assignments` | 전체 배정 목록 | 로그인 |
| POST | `/api/assignments` | 배정 생성 (중복 차단) | admin |
| DELETE | `/api/assignments/{id}` | 배정 삭제 | admin |

### 5-5. 캘린더 (`/api/calendar`)

| Method | Path | 설명 | 인증 |
|--------|------|------|------|
| GET | `/api/calendar` | 기간별 캘린더 이벤트 | 로그인 |

**쿼리 파라미터:** `start_date`, `end_date`

**응답 이벤트 필드:**
```
date, instructor_id, instructor_name, course_id, course_title,
course_status, assignment_status, class_name, assignment_id,
notion_page_id, workbook_full_url, manager, manager_email,
sales_rep, sales_rep_email
```

### 5-6. 가용성 (`/api/availability`)

| Method | Path | 설명 | 인증 |
|--------|------|------|------|
| GET | `/api/availability` | 가용성 목록 (필터) | 로그인 |
| POST | `/api/availability` | 가용성 등록 | 로그인 |
| DELETE | `/api/availability/{id}` | 가용성 삭제 | 로그인 |

**권한 제약:** instructor 역할은 자기 `instructor_id`에 대해서만 조회/생성 가능

---

## 6. 화면별 기능 명세

### 6-1. 로그인 (`/login`)

| 항목 | 내용 |
|------|------|
| 접근 | 비인증 |
| 기능 | Google OAuth 로그인 |

- Google 로그인 버튼 클릭 → Supabase OAuth 플로우
- 인증 성공 → 역할 확인 → admin이면 `/dashboard`, instructor이면 `/instructor/schedule`
- 403 (미등록 사용자) → 접근 거부 메시지 표시

### 6-2. 대시보드 (`/dashboard`) — admin

| 항목 | 내용 |
|------|------|
| 접근 | admin |
| 레이아웃 | 2컬럼 (통계 카드 + 일정 타임라인) |

**좌측 패널 — 통계 카드 (4개):**
- 활성 강사 수 (주강사/기술 튜터 구분)
- 미배정 교육 수 / 전체 교육 수
- 이번 주 교육 건수
- 오늘 교육 건수

**우측 패널 — 일정 타임라인:**
- 탭: "오늘" / "이번 주"
- 교육별 주강사/기술 튜터 이름 표시
- 배정 상태에 따른 색상 코딩 (초록=완료, 주황=미완료)
- 미배정 교육 우선 정렬

### 6-3. 강사 관리 (`/instructors`) — admin

| 항목 | 내용 |
|------|------|
| 접근 | admin |
| 레이아웃 | 테이블 + 모달 |

**기능:**
- **검색**: 이름, 이메일, 전공으로 필터
- **역할 필터**: 주강사 / 기술 튜터 / 전체 (탭)
- **활성 필터**: 전체 / 활성 / 비활성
- **정렬**: 이름순 (한글 정렬), 역할순
- **페이지네이션**: 30명/페이지
- **Notion 동기화**: 동기화 버튼 → 결과 alert

**모달:**
- 강사 상세/편집 모달: 이름(필수), 연락 이메일, 인증 이메일, 전화번호, 활성 상태
- 강사 캘린더 모달 (읽기 전용): 월간 캘린더에 배정/가용 상태 표시

### 6-4. 교육 관리 (`/courses`) — admin

| 항목 | 내용 |
|------|------|
| 접근 | admin |
| 레이아웃 | 2패널 (목록 2/3 + 상세 1/3) |

**좌측 — 교육 목록:**
- 검색 (교육명)
- 상태 필터: 전체 / 배정 완료 / 배정 미완료
- 매니저 드롭다운 필터
- 영업 담당 드롭다운 필터
- 정렬: 교육 시작일순 / 교육명순 / 배정률순
- 페이지네이션: 20건/페이지

**우측 — 교육 상세:**
- 클릭한 교육의 상세 정보
- Notion 페이지 바로가기 버튼
- 교안 바로가기 버튼
- 일차별 배정 현황 (강사명, 반 이름)
- Notion 동기화 버튼 → 결과 alert (교육/일정/배정 건수)

### 6-5. 강사 가용성 (`/availability`) — admin

| 항목 | 내용 |
|------|------|
| 접근 | admin |
| 레이아웃 | 좌측 사이드바 + 우측 매트릭스 |

**좌측 사이드바:**
- 교육 콤보박스: 교육 선택 시 해당 교육일 자동 로드
- 미니 캘린더: 날짜 멀티 선택 (클릭)
- 선택된 날짜 칩 목록 (X로 개별 해제)
- "전체 해제" 버튼
- 가용 기준 필터: N일 이상 가능한 강사만 표시

**우측 매트릭스:**
- 역할 필터 탭: 주강사 / 기술 튜터 / 전체
- 강사 × 날짜 매트릭스 테이블
  - 행: 강사 (이름 + 역할 뱃지)
  - 열: 선택된 날짜들
  - 셀: 가용 상태 (가능=초록, 배정=파랑, 불가=빨강, 미정=회색)
- 가용 일수 컬럼 (예: "3/5")
- 정렬: 가능 일수 내림차순 → 명시적 '가능' 일수 내림차순

### 6-6. 캘린더 (`/calendar`) — admin

| 항목 | 내용 |
|------|------|
| 접근 | admin |
| 레이아웃 | 미니 캘린더 + 일별 상세 패널 |

**미니 캘린더:**
- 월 이동 버튼
- 날짜별 배정 상태 표시 (초록/주황 점)
- 클릭 시 해당 날짜 상세 표시

**일별 상세 패널:**
- 매니저/영업/강사 필터 드롭다운
- 교육별 카드:
  - 배정 상태 표시 (색상 테두리)
  - 주강사 뱃지 (파랑) + 기술 튜터 뱃지 (회색)
  - Notion/교안 바로가기 아이콘
  - 매니저/영업 담당 이메일 링크

### 6-7. 내 일정 (`/instructor/schedule`) — instructor

| 항목 | 내용 |
|------|------|
| 접근 | instructor |
| 레이아웃 | 월간 캘린더 + 통계 |

**캘린더:**
- 월 이동 버튼
- 셀 배경색: 배정=파랑, 가능=초록, 불가=빨강, 미정=회색
- 배정된 날짜: 교육명 표시 (읽기 전용)
- 미배정 날짜: 클릭으로 가용성 토글 (미정 → 가능 → 불가 → 미정)

**통계 카드 (4개):**
- 배정됨, 가능, 불가, 미정 각 건수

### 6-8. 내 교육 (`/instructor/courses`) — instructor

| 항목 | 내용 |
|------|------|
| 접근 | instructor |
| 레이아웃 | 카드 목록 + 탭 |

**탭:**
- 전체 / 예정 / 완료

**교육 카드:**
- 교육명 + 상태 뱃지
- 기간, 일수, 수강생 수
- 교안 바로가기
- 일차별 상세: 날짜(요일), 시간, 장소, 역할 뱃지
- 페이지네이션: 10건/페이지

---

## 7. 초기 기획 대비 변경사항

| 항목 | 초기 설계 | 최종 구현 |
|------|----------|----------|
| 데이터 소스 | Supabase DB 직접 사용 | Notion 동기화 + FakeRepository 개발 서버 추가 |
| 가용성 조회 | 단일 날짜 선택 | 멀티 날짜 선택 + 가용성 매트릭스 UI |
| 매니저/영업 | 설계에 없었음 | manager/sales_rep 필드 추가 (Notion people 타입) |
| 복합 이름 필터 | 미고려 | "A, B" → "A" + "B" 분리 필터 |
| 탭 순서 | 전체 우선 | 주강사 우선 |
| 강사 등록 | 수동 등록 버튼 | 제거 (Notion 동기화로 대체) |
| HTTP 클라이언트 | requests (동기) | httpx.AsyncClient (비동기) |
| 인증 방식 | 미정 | Supabase JWKS + 프로필 캐시 |
